name: CI-CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_tag:
        description: "Image tag to deploy (sha tag for rollback, defaults to current commit)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  BACKEND_DIR: backend
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/inventory-pos-backend
  DEPLOY_DIR: /opt/inventory-pos

jobs:
  detect-flutter:
    runs-on: ubuntu-latest
    outputs:
      has_flutter: ${{ steps.check.outputs.has_flutter }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        shell: bash
        run: |
          if [ -f pubspec.yaml ]; then
            echo "has_flutter=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_flutter=false" >> "$GITHUB_OUTPUT"
          fi

  backend-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Lint
        working-directory: ${{ env.BACKEND_DIR }}
        shell: bash
        run: |
          if [ -f eslint.config.js ] || [ -f eslint.config.mjs ] || [ -f .eslintrc.js ] || [ -f .eslintrc.cjs ] || [ -f .eslintrc.json ]; then
            npm run lint
          else
            echo "No ESLint config found. Skipping lint step."
          fi

      - name: Test
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm test -- --passWithNoTests --runInBand

      - name: Build
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run build

  flutter-web-build:
    runs-on: ubuntu-latest
    needs: detect-flutter
    if: needs.detect-flutter.outputs.has_flutter == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Build Flutter web
        run: flutter build web --release

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-web-build
          path: build/web
          if-no-files-found: error

  docker-build:
    runs-on: ubuntu-latest
    needs: backend-ci
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=long,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          target: production
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: docker-build
    if: >
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch') &&
      secrets.PROD_HOST != '' &&
      secrets.PROD_USER != '' &&
      secrets.PROD_SSH_KEY != '' &&
      secrets.PROD_ENV_FILE != '' &&
      secrets.GHCR_USERNAME != '' &&
      secrets.GHCR_PAT != ''
    steps:
      - name: Resolve deploy tag
        id: release
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.deploy_tag }}" ]; then
            echo "tag=${{ github.event.inputs.deploy_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy production compose file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || '22' }}
          source: docker-compose.prod.yml
          target: ${{ env.DEPLOY_DIR }}

      - name: Deploy over SSH with rollback
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -euo pipefail
            mkdir -p "${{ env.DEPLOY_DIR }}"
            cd "${{ env.DEPLOY_DIR }}"

            cat > .env <<'EOF'
            ${{ secrets.PROD_ENV_FILE }}
            EOF

            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            PREVIOUS_IMAGE="$(docker inspect --format='{{.Config.Image}}' inventory-pos-backend 2>/dev/null || true)"
            TARGET_IMAGE="$(echo "${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}" | tr '[:upper:]' '[:lower:]')"
            export BACKEND_IMAGE="${TARGET_IMAGE}"

            docker compose -f docker-compose.prod.yml pull backend
            docker compose -f docker-compose.prod.yml up -d

            CURRENT_STATUS="starting"
            for _ in $(seq 1 18); do
              CURRENT_STATUS="$(docker inspect --format='{{.State.Health.Status}}' inventory-pos-backend 2>/dev/null || true)"
              if [ "${CURRENT_STATUS}" = "healthy" ]; then
                break
              fi
              sleep 5
            done

            if [ "${CURRENT_STATUS}" != "healthy" ]; then
              echo "New release is unhealthy. Rolling back."
              if [ -n "${PREVIOUS_IMAGE}" ]; then
                export BACKEND_IMAGE="${PREVIOUS_IMAGE}"
                docker compose -f docker-compose.prod.yml up -d
              fi
              exit 1
            fi
